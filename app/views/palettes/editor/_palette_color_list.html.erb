<%# locals: (palette:, colors:, total_count:, type:, mode: "add", current_slot: nil, current_color: nil, distribution: nil, palette_color_ids: [], stashed_color_ids: [], pending_background_hex: nil, pending_background_oklch_l: nil) %>

<%# Include total count as data attribute for JS to read %>
<div data-total-count="<%= total_count %>"
      data-saturation-distribution="<%= (defined?(distribution) && distribution ? distribution[:saturation] : []).to_json %>"
      data-lightness-distribution="<%= (defined?(distribution) && distribution ? distribution[:lightness] : []).to_json %>">

  <%
    # Determine background color: pending state > saved state > default
    background_hex = if type == "thread"
      pending_background_hex.presence || palette.background_color&.hex_color
    end

    # Get oklchL: pending state > saved state > nil
    background_oklch_l = if type == "thread"
      pending_background_oklch_l.presence || palette.background_color&.oklch_l
    end
  %>

  <div class="grid grid-cols-[repeat(auto-fill,minmax(7rem,1fr))] gap-3 px-3 py-8 rounded-md
              min-h-72 sm:min-h-0
              <%= 'bg-base-200' if type == 'fabric' || background_hex.nil? %>"
       data-controller="color-grid-scroll swatch-contrast"
       data-color-grid-scroll-current-color-id-value="<%= current_color&.id %>"
       data-swatch-contrast-hex-value="<%= background_hex %>"
       data-swatch-contrast-oklch-l-value="<%= background_oklch_l %>"
       data-swatch-contrast-type-value="<%= type %>"
       <% if background_hex %>style="background-color: #<%= background_hex %>;"<% end %>>

    <% if colors.any? %>
      <% colors.each do |color| %>
        <div data-color-grid-scroll-target="<%= color.id == current_color&.id ? 'currentSwatch' : '' %>">
          <%= render "palettes/editor/palette_swatch",
              color: color,
              type: type,
              mode: mode,
              current_slot: current_slot,
              is_in_palette: palette_color_ids.include?(color.id),
              is_in_stash: stashed_color_ids.include?(color.id) %>
        </div>
      <% end %>

      <% if total_count > colors.size %>
        <div class="h-28 rounded-lg border-2 border-dashed border-base-content/30 flex items-center justify-center">
          <span class="text-xs text-base-content/50 text-center px-2">
            +<%= total_count - colors.size %> more
          </span>
        </div>
      <% end %>
    <% else %>
      <div class="col-span-full flex items-center justify-center text-sm min-h-32"
           data-swatch-contrast-target="emptyMessage">
        <p>No matching colors found.</p>
      </div>
    <% end %>
  </div>
</div>
